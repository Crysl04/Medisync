{% extends 'layout.html' %}
{% block title %}MediSync - Purchases{% endblock %}

{% block content %}

<div class="main">
  <header class="dashboard-header">
    <h1>Inventory Management</h1>
    <div style="display: flex; align-items: center; gap: 10px;">
      <img src="static//profile.png"            
          alt="Profile Picture" width="40" height="40" style="border-radius: 50%;"> 
      <div>
        <strong>{{ session['name'] }}</strong><br>
        <small>Administrator</small>
      </div>
    </div>
  </header>
  
  <hr class="hr-line">

  <div class="products-controls">
    <div class="filter-btn">
      <input type="text" id="searchInput" placeholder="Search purchases..." onkeyup="searchPurchasesTable()" />
      <button onclick="togglePurchaseFilters()">
        <img src="{{ url_for('static', filename='filter.png') }}" alt="Filter Icon" class="filter-icon">
        FILTER
      </button>
      <div id="purchaseFilterOptions" class="filter-options" style="display: none;">
        <div class="filter-group">
          <label>Batch Number:</label>
          <input type="text" id="batchFilter" onkeyup="applyPurchaseFilters()" placeholder="Filter by batch number" />
        </div>
        <div class="filter-group">
          <label>Status:</label>
          <select id="statusFilter" onchange="applyPurchaseFilters()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="sold-out">Sold-out</option>
            <option value="near-expiry">Near-expiry</option>
            <option value="expired">Expired</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Purchase Date:</label>
          <input type="date" id="dateFilter" onchange="applyPurchaseFilters()" />
        </div>
      </div>
    </div>
    <button class="add-btn" onclick="openPurchaseModal()">+ Add Purchase</button>
  </div>

  <div class="purchases-table">
  <table id="purchasesTable">
    <thead>
      <tr>
        <th>Date Received</th> <!-- renamed from Purchase Date -->
        <th>Supplier</th>
        <th>Product Name</th>
        <th>Batch Number</th>
        <th>Quantity</th> <!-- was Quantity Purchased -->
        <th>Expiration Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if purchases %}
        {% for purchase in purchases %}
          <tr data-purchase-id="{{ purchase[0] }}" data-product-id="{{ purchase[1] }}">
            <td>{{ purchase[7] }}</td> <!-- Purchase Date becomes Date Received -->
            <td>{{ purchase[8] }}</td> <!-- Supplier -->
            <td>{{ purchase[1] }}</td> <!-- Item Name / Product Name -->
            <td>{{ purchase[2] }}</td> <!-- Batch Number -->
            <td>{{ purchase[3] }}</td> <!-- Quantity Purchased -->
            <td>{{ purchase[5] }}</td> <!-- Expiration Date -->
            <td>{{ purchase[6] }}</td> <!-- Status -->
            <td>
              <button onclick="editPurchase('{{ purchase[0] }}')">Edit</button>
              <button onclick="deletePurchase('{{ purchase[0] }}')">Delete</button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" style="text-align:center;">No purchases found</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

</main>

<div id="purchaseModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
  <div style="background:#fff; margin:5% auto; padding:20px; border-radius:8px; width:350px; position:relative;">
    <h2 id="modalTitle">Add Purchase</h2>
    <form id="purchaseForm" method="POST" action="/add-purchase">
      <label>Product:</label><br>
      <select name="product_id" required>
        <option value="">Select Product</option>
        {% for prod in products %}
          <option value="{{ prod[0] }}">{{ prod[1] }}</option>
        {% endfor %}
      </select><br><br>
      <label>Purchase Quantity:</label><br>
      <input type="number" name="purchase_quantity" min="1" required><br><br>
      <label>Expiration Date:</label><br>
      <input type="date" name="expiration_date" required><br><br>
      <label>Supplier:</label><br>
      <input type="text" name="supplier" required><br><br>

      <div style="text-align:right;">
        <button type="button" onclick="closePurchaseModal()">Cancel</button>
        <button type="submit" id="modalSubmit">Add</button>
      </div>
    </form>
  </div>
</div>

<style>
  td button {
    margin: 2px;
    padding: 2px 4px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  td button:first-child {
    background-color: #4CAF50;
    color: white;
  }
  td button:last-child {
    background-color: #f44336;
    color: white;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('purchasesTable');
    const cells = table.getElementsByTagName('td');
    
    for (let cell of cells) {
      cell.addEventListener('click', function() {
        const allCells = table.getElementsByTagName('td');
        for (let c of allCells) {
          c.classList.remove('expanded');
        }
        
        this.classList.toggle('expanded');
      });
    }
  });

  document.getElementById("purchaseForm").addEventListener("submit", function(e) {
  e.preventDefault(); // stop normal form submit
  const form = this;

  fetch(form.action, {
    method: "POST",
    body: new FormData(form)
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message); // pop-up for success/error
    if (data.success) location.reload(); // reload table if successful
  })
  .catch(err => alert('Error: ' + err));
});


  function searchPurchasesTable() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#purchasesTable tbody tr");

    rows.forEach(row => {
      const rowText = row.textContent.toLowerCase();
      row.style.display = rowText.includes(input) ? "" : "none";
    });
  }

  function togglePurchaseFilters() {
    const filterOptions = document.getElementById("purchaseFilterOptions");
    filterOptions.style.display = filterOptions.style.display === "none" ? "block" : "none";
  }

  function applyPurchaseFilters() {
    const batchVal = document.getElementById("batchFilter").value.toLowerCase();
    const statusVal = document.getElementById("statusFilter").value.toLowerCase();
    const dateVal = document.getElementById("dateFilter").value;
    const rows = document.querySelectorAll("#purchasesTable tbody tr");

    rows.forEach(row => {
      const batch = row.cells[2].textContent.toLowerCase();
      const status = row.cells[6].textContent.toLowerCase();
      const date = row.cells[7].textContent;

      const matchBatch = !batchVal || batch.includes(batchVal);
      const matchStatus = !statusVal || status === statusVal;
      const matchDate = !dateVal || date === dateVal;

      row.style.display = matchBatch && matchStatus && matchDate ? "" : "none";
    });
  }

  function openPurchaseModal() {
  document.getElementById("purchaseModal").style.display = "block";
}

function closePurchaseModal() {
  document.getElementById("purchaseModal").style.display = "none";
}

function editPurchase(id) {
  const row = document.querySelector(`#purchasesTable tbody tr[data-purchase-id='${id}']`);

  const productText = row.cells[2].textContent; // Product Name
  const quantity = row.cells[3].textContent;    // Quantity
  const expiry = row.cells[5].textContent;      // Expiration Date
  const supplier = row.cells[1].textContent;    // Supplier

  const form = document.getElementById("purchaseForm");
  form.action = '/edit-purchase/' + id;

  document.getElementById("modalTitle").textContent = "Edit Purchase";
  document.getElementById("modalSubmit").textContent = "Update";

  // Populate form fields
  form.product_id.value = [...form.product_id.options].find(o => o.textContent === productText).value;
  form.purchase_quantity.value = quantity;
  form.expiration_date.value = expiry;
  form.supplier.value = supplier;

  openPurchaseModal();
}


function deletePurchase(id) {
  if (confirm("Are you sure you want to delete this purchase?")) {
    fetch('/delete-purchase/' + id, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      alert(data.message); // show either success or error message
      if (data.success) location.reload(); // reload only on success
    })
    .catch(err => alert('Error deleting purchase: ' + err));
  }
}



  let currentSort = {
    column: 'id',
    direction: 'asc'
  };

  function sortTable() {
    const table = document.getElementById('purchasesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
      let aValue = a.children[getColumnIndex(currentSort.column)].textContent;
      let bValue = b.children[getColumnIndex(currentSort.column)].textContent;
      
      if (currentSort.column === 'id' || currentSort.column === 'quantity' || currentSort.column === 'remaining') {
        aValue = parseFloat(aValue.replace(/[^0-9.-]+/g, ''));
        bValue = parseFloat(bValue.replace(/[^0-9.-]+/g, ''));
      }
      
      if (currentSort.column === 'date' || currentSort.column === 'expiration') {
        aValue = new Date(aValue);
        bValue = new Date(bValue);
      }
      
      if (currentSort.direction === 'asc') {
        return aValue > bValue ? 1 : -1;
      } else {
        return aValue < bValue ? 1 : -1;
      }
    });
    
    rows.forEach(row => tbody.appendChild(row));
  }

  sortTable();

  document.querySelectorAll('.sort-btn').forEach(button => {
    button.addEventListener('click', () => {
      const column = button.dataset.sort;
      
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      
      sortTable();
    });
  });

  function getColumnIndex(column) {
    const columnMap = {
      'id': 0,
      'name': 1,
      'batch': 2,
      'quantity': 3,
      'remaining': 4,
      'expiration': 5,
      'status': 6,
      'date': 7,
      'supplier': 8
    };
    return columnMap[column];
  }
</script>

{% endblock %}
